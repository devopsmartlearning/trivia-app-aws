version: 0.2  # VersÃ£o do formato do ficheiro buildspec

env:
  variables:
    ENV: dev  # Pode ser 'dev', 'qa' ou 'prod'. Define o ambiente de destino do deploy

phases:
  install:
    runtime-versions:
      python: 3.8  # Isto ativa o pyenv do CodeBuild para Python 3.8
    commands:
      - echo "ğŸ”§ Instalando Python 3.9 manualmente..."
      - yum install -y gcc make zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel openssl-devel xz xz-devel libffi-devel wget tar
      - wget https://www.python.org/ftp/python/3.9.19/Python-3.9.19.tgz
      - tar xzf Python-3.9.19.tgz
      - cd Python-3.9.19
      - ./configure --enable-optimizations
      - make altinstall
      - ln -sf /usr/local/bin/python3.9 /usr/bin/python3.9
      - ln -sf /usr/local/bin/pip3.9 /usr/bin/pip3.9
      - python3.9 --version
      - pip3.9 --version

      - echo "ğŸ“¦ Instalando dependÃªncias da aplicaÃ§Ã£o e dos testes..."
      - pip3.9 install --upgrade pip
      - pip3.9 install -U -r back-end-python/gameactions/requirements.txt
      - pip3.9 install -U -r back-end-python/tests/requirements.txt

  build:
    commands:
      - echo "ğŸ” Analisando cÃ³digo com pylint..."
      - python3.9 -m pylint --fail-under=8 back-end-python/gameactions/app.py

      - echo "ğŸ§ª Executando testes unitÃ¡rios com cobertura..."
      - python3.9 -m pytest back-end-python/tests/unit \
          --junit-xml=unittests.xml \
          --cov-report=xml \
          --cov=gameactions \
          --cov-branch

  post_build:
    commands:
      - echo "ğŸ“¦ Construindo aplicaÃ§Ã£o com SAM..."
      - sam build --use-container

      - echo "ğŸš€ Empacotando aplicaÃ§Ã£o para o ambiente $ENV..."
      - sam package \
          --s3-bucket trivia-app-$ENV \
          --output-template-file packaged.yaml

      - echo "â˜ï¸ Fazendo deploy para o ambiente $ENV..."
      - sam deploy \
          --template-file packaged.yaml \
          --stack-name trivia-app-$ENV \
          --capabilities CAPABILITY_IAM \
          --region eu-west-1 \
          --no-confirm-changeset \
          --no-fail-on-empty-changeset

reports:
  UnitTests:
    files:
      - 'unittests.xml'
  NewCoverage:
    files:
      - 'coverage.xml'
    file-format: COBERTURAXML

artifacts:
  files:
    - template.yaml
    - packaged.yaml
    - build/**/*
